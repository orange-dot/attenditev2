# Full Development Setup (~15-20 GB)
# Sve komponente uključujući auth, storage, policy engine i monitoring
#
# Pokreni sa: docker-compose -f docker-compose.dev.yml up -d
#
# Komponente:
# - PostgreSQL (baza)
# - KurrentDB/EventStoreDB (event streaming)
# - Keycloak (autentifikacija)
# - MinIO (document storage)
# - OPA (policy engine)
# - Prometheus (metrics)
# - Grafana (dashboards)
# - Loki (logs)
# - Platform API

version: '3.8'

services:
  # ===========================================
  # PostgreSQL - Glavna baza podataka
  # ===========================================
  postgres:
    image: postgres:15-alpine
    container_name: platform-postgres
    environment:
      POSTGRES_USER: platform
      POSTGRES_PASSWORD: platform_dev_2024
      POSTGRES_DB: platform
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U platform"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - platform-net

  # ===========================================
  # Keycloak PostgreSQL (odvojena baza)
  # ===========================================
  keycloak-db:
    image: postgres:15-alpine
    container_name: platform-keycloak-db
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak_dev_2024
      POSTGRES_DB: keycloak
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - platform-net

  # ===========================================
  # Keycloak - Identity Provider
  # ===========================================
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: platform-keycloak
    command: start-dev --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak_dev_2024
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: "8180"
      KC_HTTP_PORT: "8180"
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin_dev_2024
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    ports:
      - "8180:8180"
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8180"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - platform-net

  # ===========================================
  # KurrentDB (EventStoreDB) - Event Streaming
  # ===========================================
  kurrentdb:
    image: eventstore/eventstore:24.2.0-jammy
    container_name: platform-kurrentdb
    environment:
      EVENTSTORE_CLUSTER_SIZE: 1
      EVENTSTORE_RUN_PROJECTIONS: All
      EVENTSTORE_START_STANDARD_PROJECTIONS: "true"
      EVENTSTORE_INSECURE: "true"
      EVENTSTORE_ENABLE_ATOM_PUB_OVER_HTTP: "true"
    ports:
      - "2113:2113"   # HTTP/gRPC
      - "1113:1113"   # TCP (legacy)
    volumes:
      - kurrentdb_data:/var/lib/eventstore
      - kurrentdb_logs:/var/log/eventstore
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:2113/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - platform-net

  # ===========================================
  # MinIO - Document Storage (S3 compatible)
  # ===========================================
  minio:
    image: minio/minio:latest
    container_name: platform-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin_dev_2024
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - platform-net

  # MinIO bucket initialization
  minio-init:
    image: minio/mc:latest
    container_name: platform-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set platform http://minio:9000 minioadmin minioadmin_dev_2024;
      mc mb --ignore-existing platform/documents;
      mc mb --ignore-existing platform/exports;
      mc mb --ignore-existing platform/temp;
      mc anonymous set download platform/exports;
      echo 'MinIO buckets created successfully';
      "
    networks:
      - platform-net

  # ===========================================
  # OPA - Policy Engine
  # ===========================================
  opa:
    image: openpolicyagent/opa:latest
    container_name: platform-opa
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=info"
      - "--set=decision_logs.console=true"
      - "/policies"
    ports:
      - "8181:8181"
    volumes:
      - ../opa/policies:/policies:ro
    # OPA scratch image has no shell - healthcheck disabled for dev
    restart: unless-stopped
    networks:
      - platform-net

  # ===========================================
  # Prometheus - Metrics Collection
  # ===========================================
  prometheus:
    image: prom/prometheus:v2.50.0
    container_name: platform-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - platform-net

  # ===========================================
  # Grafana - Dashboards
  # ===========================================
  grafana:
    image: grafana/grafana:10.3.0
    container_name: platform-grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin_dev_2024
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: http://localhost:3000
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-piechart-panel
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
      - loki
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - platform-net

  # ===========================================
  # Loki - Log Aggregation
  # ===========================================
  loki:
    image: grafana/loki:2.9.0
    container_name: platform-loki
    command: -config.file=/etc/loki/loki.yml
    ports:
      - "3100:3100"
    volumes:
      - ./loki/loki.yml:/etc/loki/loki.yml:ro
      - loki_data:/loki
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - platform-net

  # ===========================================
  # Promtail - Log Collector
  # ===========================================
  promtail:
    image: grafana/promtail:2.9.0
    container_name: platform-promtail
    command: -config.file=/etc/promtail/promtail.yml
    volumes:
      - ./promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      - /var/log:/var/log:ro
      - promtail_positions:/tmp
    depends_on:
      - loki
    restart: unless-stopped
    networks:
      - platform-net

  # ===========================================
  # Platform API
  # ===========================================
  platform:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    container_name: platform-api
    environment:
      ENV: development
      SERVER_PORT: "8080"
      # Database
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_USER: platform
      DB_PASSWORD: platform_dev_2024
      DB_NAME: platform
      # KurrentDB (EventStoreDB)
      KURRENTDB_HOST: kurrentdb
      KURRENTDB_PORT: "2113"
      KURRENTDB_INSECURE: "true"
      # Auth
      JWT_SECRET: dev-secret-change-in-production
      KEYCLOAK_URL: http://keycloak:8180
      KEYCLOAK_REALM: platform
      # OPA
      OPA_ENABLED: "true"
      OPA_URL: http://opa:8181
      # MinIO
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin_dev_2024
      MINIO_BUCKET: documents
      MINIO_USE_SSL: "false"
      # Privacy
      PRIVACY_FACILITY_TYPE: central
      PRIVACY_FACILITY_CODE: CENTRAL-DEV-001
      PRIVACY_HMAC_KEY: dev-hmac-key-change-in-production-use-hsm
      PRIVACY_GUARD_ENABLED: "true"
      PRIVACY_BLOCK_VIOLATIONS: "true"
      PRIVACY_LOG_VIOLATIONS: "true"
      PRIVACY_TOKEN_TTL_HOURS: "1"
      PRIVACY_MAX_TOKEN_USES: "3"
      PRIVACY_DEFAULT_AI_ACCESS_LEVEL: "0"
      # Event Store
      EVENTSTORE_ENABLED: "true"
      EVENTSTORE_SNAPSHOT_THRESHOLD: "100"
      # Logging
      LOG_LEVEL: debug
      LOG_FORMAT: json
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      kurrentdb:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      opa:
        condition: service_started
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - platform-net
    logging:
      driver: loki
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-batch-size: "100"
        loki-retries: "2"

volumes:
  postgres_data:
    driver: local
  keycloak_db_data:
    driver: local
  kurrentdb_data:
    driver: local
  kurrentdb_logs:
    driver: local
  minio_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  loki_data:
    driver: local
  promtail_positions:
    driver: local

networks:
  platform-net:
    name: platform-dev
    driver: bridge
